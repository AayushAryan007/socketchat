{% extends 'userapp/base.html' %}
{% block title %}Chat with {{ friend.get_full_name }}{% endblock %}
{% block content %}
<div class="row mt-4">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex align-items-center">
                {% if friend.profile.avatar %}
                    <img src="{{ friend.profile.avatar.url }}" class="rounded-circle me-2" width="40" height="40" style="object-fit: cover;">
                {% else %}
                    <img src="https://via.placeholder.com/40" class="rounded-circle me-2" width="40" height="40">
                {% endif %}
                <div>
                    <strong>{{ friend.get_full_name }}</strong>
                    <div><small>@{{ friend.username }}</small></div>
                </div>
                <a href="{% url 'chat_list' %}" class="btn btn-sm btn-light ms-auto">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
            
            <div class="card-body" id="chat-messages" style="height: 450px; overflow-y: auto; background-color: #f8f9fa;">
                {% for msg in messages %}
                    <div class="mb-3 {% if msg.sender == user %}text-end{% endif %}">
                        <div class="d-inline-block">
                            <div class="badge {% if msg.sender == user %}bg-primary{% else %}bg-secondary{% endif %} mb-1">
                                {{ msg.sender.get_full_name }}
                            </div>
                            <div class="p-2 rounded {% if msg.sender == user %}bg-primary text-white{% else %}bg-white{% endif %}" 
                                 style="max-width: 400px; word-wrap: break-word;">
                                {{ msg.text|escape }}
                            </div>
                            <small class="text-muted d-block">{{ msg.timestamp|timesince }} ago</small>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <div class="card-footer">
                <form id="chat-form" autocomplete="off">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type a message..." required>
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
(function(){
    const roomId = "{{ room.id }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsScheme + '://' + window.location.host + '/ws/chat/' + roomId + '/';
    
    // Store current room ID globally for navbar badge
    window.currentChatRoomId = roomId;
    
    let chatSocket = new WebSocket(wsUrl);
    
    chatSocket.onopen = function(e) {
        console.log('Chat WebSocket connected');
        // Update navbar badge excluding this room
        if (typeof updateChatCount === 'function') {
            updateChatCount();
        }
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'chat_message') {
            appendMessage(data.sender, data.sender_name, data.message);
        } else if (data.type === 'unread_update') {
            // Update navbar badge when message received
            if (typeof updateChatCount === 'function') {
                updateChatCount();
            }
        }
    };
    
    chatSocket.onerror = function(e) {
        console.error('Chat WebSocket error:', e);
    };
    
    chatSocket.onclose = function(e) {
        console.log('Chat WebSocket closed');
        window.currentChatRoomId = null; // Clear when disconnected
        if (e.code !== 1000) {
            setTimeout(() => {
                console.log('Attempting to reconnect...');
                location.reload();
            }, 3000);
        }
    };
    
    function appendMessage(sender, senderName, text) {
        const chatMessages = document.getElementById('chat-messages');
        const currentUser = "{{ user.username }}";
        const isOwn = sender === currentUser;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'mb-3 ' + (isOwn ? 'text-end' : '');
        messageDiv.innerHTML = `
            <div class="d-inline-block">
                <div class="badge ${isOwn ? 'bg-primary' : 'bg-secondary'} mb-1">${senderName}</div>
                <div class="p-2 rounded ${isOwn ? 'bg-primary text-white' : 'bg-white'}" 
                     style="max-width: 400px; word-wrap: break-word;">
                    ${escapeHtml(text)}
                </div>
                <small class="text-muted d-block">Just now</small>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    document.getElementById('chat-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const input = document.getElementById('message-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({'message': message}));
            input.value = '';
        } else {
            alert('Connection lost. Please refresh the page.');
        }
    });
    
    // Scroll to bottom on load
    document.getElementById('chat-messages').scrollTop = 
        document.getElementById('chat-messages').scrollHeight;
})();
</script>
{% endblock %}